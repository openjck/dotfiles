#!/usr/bin/env bash

# Install the dependencies for the dotfiles-openjck-setup script, then run it.
#
# The dotfiles-openjck-setup script is written in Python. uv is used to ensure
# that the correct version of Python is installed, as well as to ensure that all
# Python packages that the script depends on are installed. For that reason, uv
# must be installed before running the script. This script installs uv.
#
# The dotfiles-openjck-setup script installs docopts, so docopts is not used in
# this script itself.

# MIT License
#
# Copyright (c) 2026 John Karahalis
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

# Use "strict mode."
#
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail

function os_is_debian_based() {
  [[ -f /etc/debian_version ]]
}

# Install pipx if it's not already installed.
#
# pipx is needed to install uv, and uv is needed to run the setup script.
if ! command -v pipx > /dev/null; then
  if os_is_debian_based; then
    sudo apt-get install --assume-yes pipx
  else
    >&2 echo 'This distro is not supported.'
    exit 1
  fi
fi

# Install uv if it's not already installed.
#
# uv is needed to run the setup script.
if ! command -v uv > /dev/null; then
  pipx install uv
fi

# Install git if it's not already installed.
#
# git is used within the setup script. I could use a Python package for
# interacting with Git, which would make this step unnecessary, but I'd rather
# not learn another tool and keep the dependency updated.
if ! command -v pipx > /dev/null; then
  if os_is_debian_based; then
    sudo apt-get install --assume-yes git
  else
    >&2 echo 'This distro is not supported.'
    exit 1
  fi
fi

"$HOME"/bin/vcsh/dotfiles-openjck-setup/dotfiles-openjck-setup "$@"
