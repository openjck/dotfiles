#!/usr/bin/env bash

# Install the dependencies of the main setup script, then run it.
#
# This script therefore functions like a bootstrap script.
#
# The main setup script is written in Python. The Python tool "uv" is used to
# ensure that the correct version of Python is installed, as well as all Python
# packages that the script depends on. For that reason, uv must be installed
# before running the script. This script installs uv.
#
# The main setup script installs docopts, so docopts is not used in this script
# itself.

# Use Bash's unofficial "strict mode."
#
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -o errexit
set -o nounset
set -o pipefail
IFS=$'\n\t'

function os_is_debian_based() {
  [[ -f /etc/debian_version ]]
}

if ! os_is_debian_based; then
  >&2 echo 'FATAL ERROR: This distro is not supported.'
  exit 1
fi

# In addition to checking if the user has (some form of) sudo access, this
# prompts the user for their password once, now, at the beginning of the setup
# process, so that they don't need to be prompted for it in the middle of the
# setup process.
if ! sudo --validate; then
  >&2 echo "FATAL ERROR: \"sudo\" must be installed and enabled for \"$USER\"."
  exit 1
fi

# Install pip if it's not already installed.
#
# pip is needed to install uv, and uv is needed to run the setup script.
if ! command -v pip > /dev/null; then
  if os_is_debian_based; then
    sudo apt-get install --assume-yes pipx
  fi
fi

if ! command -v uv > /dev/null; then
  pipx install uv
fi

# uv was already installed to $HOME/.local/bin, so add that to the $PATH.
#
# The new $HOME/.profile file, which includes that in the $PATH, has not yet
# been applied, and some distros don't include $HOME/.local/bin on the $PATH by
# default.
PATH=$HOME/.local/bin:$PATH

# Homebrew _will be_ installed to /home/linuxbrew/.linuxbrew/bin, so add that to
# the $PATH. If this were not done, "brew" commands would fail later.
PATH=/home/linuxbrew/.linuxbrew/bin:$PATH

"$HOME"/bin/personal/vcsh/dotfiles-openjck-setup-main/dotfiles-openjck-setup-main.py
